#include "uart_interface.h"
#include "xil_printf.h"
#include "xuartlite.h"

XUartLite usb_uart;

int connect_uart_interrupt(XIntc *InterruptController)
{
    XUartLite_Initialize(&usb_uart, STDOUT_BASEADDRESS);
    int Status;

	// Connect the UART interrupt handler
    Status = XIntc_Connect(InterruptController, UART_INT_ID, (XInterruptHandler)uart_handler, (void*)0);
    if (Status != XST_SUCCESS) return XST_FAILURE;
    // XUartLite_SetRecvHandler(&usb_uart, uart_handler, &usb_uart);

    return XST_SUCCESS;
}

void enable_uart_interrupt(XIntc *InterruptController)
{
    // Enable the UART interrupt
    XIntc_Enable(InterruptController, UART_INT_ID);
    XUartLite_EnableInterrupt(&usb_uart);
}

void uart_handler(void* CallbackRef)
{
	outbyte('r');
    char c = inbyte();
	xil_printf("'%c' 0x%02X %i\r\n", c, c, XUartLite_IsSending(&usb_uart));
}
